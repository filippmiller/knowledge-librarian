# Session Notes: Telegram Bot — Access Control, Knowledge Management, Document Upload

**Date:** 2026-02-14 15:00–23:50
**Area:** Telegram Bot (full system)
**Type:** feature + multiple bugfixes
**Log Entry:** `.claude/agent-log.md` (6 entries from this session)

## Context

User requested transformation of the Telegram bot (@avroratranslatebot) from an open Q&A bot into a secure, admin-managed knowledge system. A detailed plan was provided covering 6 phases: DB schema, access control, message routing, knowledge management, voice messages, document upload, and deployment.

## What Was Done

### Phase 1: Database + Access Control
- Added `TelegramUserRole` enum (SUPER_ADMIN, ADMIN, USER) and `TelegramUser` model to Prisma schema
- Created `access-control.ts` with DB-backed access checking
- Bootstrap: TELEGRAM_SUPER_ADMIN env var auto-creates first super admin
- Schema pushed to Railway via `railway run npx prisma db push`

### Phase 2: Message Router + Commands
- Created `message-router.ts` routing by content type (text/voice/document) and user role
- Created `commands.ts` with all command handlers
- Simplified `route.ts` from ~220 lines to ~35 lines

### Phase 3: Knowledge Management
- Created `knowledge-manager.ts` with `addKnowledge()` and `correctKnowledge()`
- AI parses admin text into structured Rules and QA pairs
- Auto-classifies domain, generates next rule code, creates embeddings

### Phase 4: Voice Messages
- Created `voice-handler.ts` with OpenAI Whisper integration
- Downloads .ogg → transcribes → routes by keywords (add/correct/question)

### Phase 5: Document Upload
- Created `document-handler.ts` with non-streaming 3-phase pipeline
- Downloads file from Telegram → parseDocument → classify domains → extract knowledge → chunk + embed

### Phase 6: Deploy + Iterative Bugfixes
- Deployed to Railway, set TELEGRAM_SUPER_ADMIN=96683003
- Added Яна (234742362) as SUPER_ADMIN

## Bugfixes Applied (Iterative, from user testing)

### Bug 1: Voice "поменяй" routed to Q&A
- **Root cause:** Voice handler only had ADD keywords (добавь, запомни)
- **Fix:** Added CORRECT_KEYWORDS regex with поменяй, измени, исправь, обнови, замени

### Bug 2: Confidence line split into separate message bubble
- **Root cause:** MarkdownV2 escaping doubled character count, hitting splitMessage threshold
- **Fix:** Switched all messages to plain text (removed MarkdownV2)

### Bug 3: /correct created duplicates instead of updating rules
- **Root cause:** `correctKnowledge()` superseded old rule and created new one, but old document chunks with outdated prices remained in search
- **Fix:** Complete rewrite — now updates rule body in-place (same ruleCode), deprecates old QA pairs, deletes conflicting chunks using word overlap matching (>30% threshold), creates fresh chunk

### Bug 4: /add text limit too low (2000 chars)
- **Fix:** Raised to 10000 characters

### Bug 5: rawBytes not saved on document upload
- **Fix:** Added `rawBytes: buffer` to prisma.document.create

### Bug 6: 0 QA pairs generated from documents
- **Root cause:** Extraction prompt too minimal ("Извлеки правила и QA пары"), AI treated QA pairs as optional
- **Fix:** Rewrote prompt to explicitly require 1-2 QA pairs per rule, increased maxTokens to 8192

### Enhancement: Detailed processing summary
- Summary now shows: document name, ID, domain names, list of rules (code + title), list of QA questions, chunk count

### Enhancement: Telegram slash command menu
- Added `setBotCommands()` registering 12 commands with descriptions
- Lazy registration on first message or health check

## Technical Decisions

| Decision | Rationale | Alternatives Considered |
|----------|-----------|------------------------|
| Plain text over MarkdownV2 | MarkdownV2 escaping doubled message size, caused splits | Could escape selectively, but plain text is simpler and avoids all issues |
| In-place rule update over supersede | Old approach left conflicting chunks in search, users got contradictory answers | Could version rules, but in-place is simpler for a bot workflow |
| Word overlap matching for chunk deletion | Semantic embedding comparison is expensive; word overlap (>30%) is fast and effective | Could use cosine similarity, but adds latency |
| 8192 maxTokens for extraction | With QA pairs required, output can be 2-3x larger | 4096 was truncating responses silently |
| Non-streaming pipeline for Telegram | Telegram messages are async; no need for SSE streaming | Could stream, but adds complexity with no user benefit |

## Files Changed (Full List)

| File | Action | Description |
|------|--------|-------------|
| `prisma/schema.prisma` | Modified | Added TelegramUserRole enum, TelegramUser model |
| `src/lib/telegram/telegram-api.ts` | Created | sendMessage (plain text), typing/upload indicators, downloadFile, setBotCommands |
| `src/lib/telegram/access-control.ts` | Created | DB-backed access control, role checks, user management |
| `src/lib/telegram/message-router.ts` | Created | Routes text/voice/document by type + role |
| `src/lib/telegram/commands.ts` | Created | 12+ command handlers (start, help, grant, revoke, promote, demote, users, add, correct, show, edit, delete) |
| `src/lib/telegram/voice-handler.ts` | Created | Whisper transcription + keyword routing |
| `src/lib/telegram/document-handler.ts` | Created | 3-phase document pipeline, enhanced summary |
| `src/lib/telegram/knowledge-manager.ts` | Created | AI-assisted knowledge parsing, in-place correction |
| `src/app/api/telegram/route.ts` | Modified | Simplified to ~50 lines, delegates to router, lazy setBotCommands |

## Functions & Symbols

| Symbol | File | Action | Description |
|--------|------|--------|-------------|
| `TelegramUser` | schema.prisma | New | Access control model |
| `TelegramUserRole` | schema.prisma | New | SUPER_ADMIN, ADMIN, USER enum |
| `checkAccess()` | access-control.ts | New | DB check, auto-creates super admin |
| `grantAccess()` | access-control.ts | New | Add user to whitelist |
| `revokeAccess()` | access-control.ts | New | Deactivate user |
| `promoteUser()` | access-control.ts | New | USER → ADMIN |
| `demoteUser()` | access-control.ts | New | ADMIN → USER |
| `handleUpdate()` | message-router.ts | New | Main entry point, routes updates |
| `routeTextMessage()` | message-router.ts | New | Parses /commands, routes to handlers |
| `handleStart()` | commands.ts | New | Welcome message |
| `handleHelp()` | commands.ts | New | Command reference |
| `handleGrant()` | commands.ts | New | Grant access |
| `handleRevoke()` | commands.ts | New | Revoke access |
| `handlePromote()` | commands.ts | New | Promote to admin |
| `handleDemote()` | commands.ts | New | Demote from admin |
| `handleUsers()` | commands.ts | New | List users |
| `handleAdd()` | commands.ts | New | Add knowledge text |
| `handleCorrect()` | commands.ts | New | Correct existing rules |
| `handleShow()` | commands.ts | New | List or show rule details |
| `handleEdit()` | commands.ts | New | Edit specific rule |
| `handleDelete()` | commands.ts | New | Delete rule |
| `handleQuestion()` | commands.ts | New | Q&A via enhanced engine |
| `handleVoiceMessage()` | voice-handler.ts | New | Whisper → keyword routing |
| `handleDocumentUpload()` | document-handler.ts | New | Full 3-phase pipeline |
| `classifyDomains()` | document-handler.ts | New | Non-streaming domain classification |
| `extractKnowledge()` | document-handler.ts | New | AI extraction with mandatory QA pairs |
| `createChunks()` | document-handler.ts | New | Chunking + embedding |
| `addKnowledge()` | knowledge-manager.ts | New | Parse text → rules + QA |
| `correctKnowledge()` | knowledge-manager.ts | New | In-place rule correction |
| `deleteConflictingChunks()` | knowledge-manager.ts | New | Word overlap chunk deletion |
| `createKnowledgeChunk()` | knowledge-manager.ts | New | Embedding + chunk creation |
| `sendMessage()` | telegram-api.ts | New | Plain text, splits at 4000 chars |
| `setBotCommands()` | telegram-api.ts | New | Register 12 commands with Telegram |
| `downloadFile()` | telegram-api.ts | New | Download via getFile API |

## Database Impact

| Table | Action | Details |
|-------|--------|---------|
| `TelegramUser` | New table | Access control with roles, active status |
| `Document` | Created by uploads | rawBytes now populated |
| `Rule` | Created/Updated | In-place updates by correctKnowledge |
| `QAPair` | Created/Deprecated | Old pairs deprecated on correction |
| `DocChunk` | Created/Deleted | Conflicting chunks removed on correction |
| `DocumentDomain` | Created | Domain classification links |
| `RuleDomain` | Created/Copied | Copied on rule edit |
| `QADomain` | Created | Domain links for QA pairs |
| `ChunkDomain` | Created/Deleted | Cascade deleted with chunks |

## Commits

- `d023ba0` — feat: add Telegram bot access control, knowledge management, and document upload
- `1f781fd` — fix: voice keyword routing, add /show /edit /delete commands, plain text messages
- `d2f6e0e` — fix: correct rules in-place, add slash command menu, add Яна as super admin
- `cdd7d4b` — fix: raise text length limit from 2000 to 10000 chars
- `b2bb344` — fix: save original file bytes (rawBytes) when uploading documents via bot
- `dc04725` — fix: improve document extraction - require QA pairs and show detailed summary

## Environment Variables

| Variable | Value | Purpose |
|----------|-------|---------|
| `TELEGRAM_BOT_TOKEN` | Already set | Bot authentication |
| `TELEGRAM_SUPER_ADMIN` | 96683003 | Bootstrap super admin (filipp) |

## Users Added

| Telegram ID | Username | Role | Added By |
|-------------|----------|------|----------|
| 96683003 | @Filippmiller | SUPER_ADMIN | Auto-bootstrap |
| 234742362 | @LipovoeVarenie (Яна) | SUPER_ADMIN | SQL insert |

## Gotchas & Notes for Future Agents

1. **Prisma DLL lock**: The dev server holds `query_engine-windows.dll.node`. Must kill node process before running `prisma generate` on Windows.

2. **MarkdownV2 is abandoned**: All Telegram messages use plain text. MarkdownV2 escaping was doubling message size and causing splits. Don't re-add it.

3. **correctKnowledge updates in-place**: Rules keep their original R-X code. Old QA pairs are set to DEPRECATED. Conflicting chunks are deleted using word overlap matching (>30% threshold).

4. **Document rawBytes**: The original file binary is now saved in the Document record. This was missing before commit b2bb344.

5. **maxTokens for extraction**: Set to 8192 because with mandatory QA pairs, extraction output can be 2-3x larger than rules alone. If truncation occurs, increase further.

6. **Voice keyword routing**: Two regex sets — ADD_KEYWORDS and CORRECT_KEYWORDS. If a transcription doesn't match either, it falls through to Q&A. Keywords are matched at the START of the transcription only.

7. **setBotCommands lazy init**: Commands are registered on first incoming message or health check GET. The `commandsRegistered` flag is in-memory, so it resets on deploy. This is fine — Telegram just overwrites.

8. **Telegram 4000 char split**: Messages are split at newline boundaries when over 4000 chars. The detailed document summary can be long with many rules — it will split into multiple messages automatically.

---
