# Full Document Processing Test

## –¶–µ–ª—å

–ü—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º Railway –ª–æ–≥–æ–≤ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –ø–∞–º—è—Ç–∏ (OOM).

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏–∫—Å—ã

### ‚úÖ 1. Batch Processing (–ë–∞—Ç—á–µ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞)
- **–§–∞–π–ª**: `src/lib/ai/knowledge-extractor-stream.ts`
- **–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å**: –í–º–µ—Å—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (12000 —Å–∏–º–≤–æ–ª–æ–≤) –∑–∞ —Ä–∞–∑, —Ç–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±–∞—Ç—á–∞–º–∏ –ø–æ 3000 —Å–∏–º–≤–æ–ª–æ–≤
- **–ó–∞—á–µ–º**: –°–Ω–∏–∂–∞–µ—Ç –ø–∏–∫–æ–≤–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –Ω–∞ Railway

### ‚úÖ 2. Memory Management (–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é)
- **–§–∞–π–ª—ã**: 
  - `src/app/api/documents/[id]/process-stream/route.ts`
  - `src/lib/ai/chunker.ts`
- **–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å**: –î–æ–±–∞–≤–ª–µ–Ω —è–≤–Ω—ã–π garbage collection (`global.gc()`) –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **–ó–∞—á–µ–º**: –û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –ø–∞–º—è—Ç—å –º–µ–∂–¥—É —Ñ–∞–∑–∞–º–∏ –Ω–∞ Railway

### ‚úÖ 3. Progress Tracking (–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞)
- **–§–∞–π–ª**: `src/lib/ai/knowledge-extractor-stream.ts`
- **–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å**: –î–æ–±–∞–≤–ª–µ–Ω —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è `batch_progress` –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–∞—Ç—á–µ–π
- **–ó–∞—á–µ–º**: –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤–∏–¥–µ—Ç—å, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–≤–∏—Å, –∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ

### ‚úÖ 4. Enhanced Checkpointing (–£–ª—É—á—à–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏)
- **–§–∞–π–ª**: `src/app/api/documents/[id]/process-stream/route.ts`
- **–ß—Ç–æ —É–∂–µ –±—ã–ª–æ**: Resume capability –∏ staged extractions
- **–£–ª—É—á—à–µ–Ω–∏—è**: –î–æ–±–∞–≤–ª–µ–Ω GC –º–µ–∂–¥—É —Ñ–∞–∑–∞–º–∏ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏

### ‚úÖ 5. Enhanced Monitoring (–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
- **–§–∞–π–ª**: `tests/full-upload-test.spec.ts`
- **–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å**: 
  - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ failed requests
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ server errors (500, 503, 429)
  - –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ OOM –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
  - –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

## –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π (—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º Railway)

```powershell
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
.\scripts\run-full-test-with-monitoring.ps1
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:**
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç prerequisites (Playwright, Railway CLI)
2. üöÇ –ó–∞–ø—É—Å–∫–∞–µ—Ç Railway log monitor –≤ —Ñ–æ–Ω–µ
3. üß™ –ó–∞–ø—É—Å–∫–∞–µ—Ç Playwright —Ç–µ—Å—Ç —Å headed –±—Ä–∞—É–∑–µ—Ä–æ–º
4. üìä –°–æ–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ screenshots
5. üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–æ–π (—Ä–∞–∑–¥–µ–ª—å–Ω—ã–µ –æ–∫–Ω–∞)

**–¢–µ—Ä–º–∏–Ω–∞–ª 1 - Railway Logs:**
```powershell
.\scripts\monitor-railway-logs.ps1
```

**–¢–µ—Ä–º–∏–Ω–∞–ª 2 - Playwright Test:**
```powershell
npx playwright test tests/full-upload-test.spec.ts --headed --reporter=list
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ü—Ä–æ—Å—Ç–æ–π (–±–µ–∑ Railway –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)

```powershell
npx playwright test tests/full-upload-test.spec.ts --headed
```

## –ß—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å

### –í Playwright —Ç–µ—Å—Ç–µ:
- ‚úÖ –§–∞–∑—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏: "–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ–º–µ–Ω–æ–≤", "–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏–π", "–†–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ —á–∞–Ω–∫–∏"
- ‚úÖ Batch progress: `[Batch 1/3]`, `[Batch 2/3]`, etc.
- ‚úÖ COMPLETED —Å—Ç–∞—Ç—É—Å –≤ –∫–æ–Ω—Ü–µ
- ‚ùå Server errors (500, 503)
- ‚ùå OOM messages

### –í Railway –ª–æ–≥–∞—Ö:
- ‚úÖ `[Knowledge Extraction] Processing in X batch(es)` - –±–∞—Ç—á–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ `[process-stream] Forced GC after PHASE` - GC —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ `Batch X complete: Y rules, Z QAs` - –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚ùå `Out of memory` / `OOM` - –æ—à–∏–±–∫–∞ –ø–∞–º—è—Ç–∏
- ‚ùå `Error: spawn ENOMEM` - –Ω–µ—Ö–≤–∞—Ç–∫–∞ –ø–∞–º—è—Ç–∏ –¥–ª—è spawn –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### Screenshots (test-results/)
- `full-test-01-documents.png` - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- `full-test-02-terminal-start.png` - –Ω–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `full-test-phase-*.png` - –∫–∞–∂–¥–∞—è —Ñ–∞–∑–∞
- `full-test-03-completion.png` - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
- `full-test-04-documents-final.png` - —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- `full-test-05-rules.png` - –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
- `full-test-06-qa.png` - Q&A –ø–∞—Ä—ã
- `full-test-07-domains.png` - –¥–æ–º–µ–Ω—ã

### Console Output
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- Failed requests (–µ—Å–ª–∏ –µ—Å—Ç—å)
- Server errors (–µ—Å–ª–∏ –µ—Å—Ç—å)
- –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—á–µ—Ç –ø—Ä–∞–≤–∏–ª –∏ QA

## Troubleshooting

### Railway CLI –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
```powershell
npm install -g @railway/cli
railway login
```

### –¢–µ—Å—Ç –ø–∞–¥–∞–µ—Ç —Å timeout
- –£–≤–µ–ª–∏—á—å—Ç–µ timeout –≤ `full-upload-test.spec.ts` (—Å–µ–π—á–∞—Å 10 –º–∏–Ω—É—Ç)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Railway –ª–æ–≥–∏ –Ω–∞ OOM

### OOM –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
**–î–∞–ª—å–Ω–µ–π—à–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
1. –£–º–µ–Ω—å—à–∏—Ç—å `BATCH_SIZE` —Å 3000 –¥–æ 2000 —Å–∏–º–≤–æ–ª–æ–≤
2. –£–º–µ–Ω—å—à–∏—Ç—å `EMBEDDING_BATCH_SIZE` —Å 5 –¥–æ 3
3. –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –ø–∞–º—è—Ç–∏
4. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Railway Pro –ø–ª–∞–Ω (–±–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏)

### Process –Ω–µ resume –ø–æ—Å–ª–µ crash
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `stagedExtraction` –≤ –ë–î
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å `?resume=true` –∫ URL process-stream
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–∑—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ DB

## Railway Environment Variables

–î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è GC –Ω–∞ Railway, –¥–æ–±–∞–≤—å—Ç–µ –≤ Railway environment variables:

```bash
NODE_OPTIONS=--expose-gc
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –∫–æ–¥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `global.gc()` –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –ø–∞–º—è—Ç–∏.

## Next Steps

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞:
1. ‚úÖ Commit –∏–∑–º–µ–Ω–µ–Ω–∏—è
2. ‚úÖ Push –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
3. ‚úÖ Deploy –Ω–∞ Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
4. ‚úÖ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ—Å—Ç –Ω–∞ production URL
5. üìù –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
